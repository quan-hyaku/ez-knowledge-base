{
  "project": "EzKnowledgeBase — Security, Performance, Workflow, Accessibility \u0026 API Hardening",
  "description": "EzKnowledgeBase is a self-contained Laravel knowledge base package with categories, articles, search, feedback, and support tickets. A comprehensive audit across five areas — security, performance, end-user workflow, accessibility, and API design — revealed numerous issues ranging from critical XSS vulnerabilities to broken UI elements and WCAG failures. This PRD defines the work needed to bring the package up to industry best practices, making it production-ready for enterprise use.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Fix XSS via Markdown HTML Allowance in API",
      "description": "As a developer consuming the API, I need body_html to be safe to render so that my application is not vulnerable to stored XSS from article content.",
      "acceptanceCriteria": [
        "ApiController.php uses 'html_input' =\u003e 'escape' (matching the web controller) instead of 'html_input' =\u003e 'allow'",
        "Raw \u003cscript\u003e tags in article body are escaped in API body_html responses",
        "Web controller's {!! $parsedBody !!} output is passed through an HTML sanitizer (e.g., HTMLPurifier) before rendering",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Use Timing-Safe API Key Comparison",
      "description": "As a security-conscious deployer, I need the API key comparison to be constant-time so that attackers cannot use timing side-channels to reconstruct the secret key.",
      "acceptanceCriteria": [
        "ApiAuthenticate.php uses hash_equals($apiKey, $request-\u003eheader('X-KB-API-Key') ?? '') instead of ===",
        "Unauthenticated requests still return 401",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Add Server-Side Input Validation to All Endpoints",
      "description": "As a developer, I need all user input validated server-side so that the application rejects malformed or malicious data.",
      "acceptanceCriteria": [
        "Feedback endpoint validates vote with required|in:yes,no and returns 422 for invalid values",
        "Ticket category field validates with nullable|in:billing,technical,feature,general,other",
        "Ticket description field has max:10000 (or similar reasonable limit)",
        "API search q parameter validated with max:500",
        "API search category parameter validated as existing category slug",
        "Route parameter $id in feedback endpoint is type-hinted as int",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Add Server-Side Feedback Vote Deduplication",
      "description": "As a product owner, I need feedback votes to be deduplicated server-side so that vote counts are trustworthy and cannot be manipulated.",
      "acceptanceCriteria": [
        "Votes are tracked by session ID (or user ID if authenticated) in a kb_article_feedback table or via session storage",
        "Duplicate votes from the same session/user for the same article are rejected with a 409 or ignored gracefully",
        "Client-side localStorage check retained as a UX optimization (not sole enforcement)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Fix or Remove Non-Functional File Upload in Ticket Form",
      "description": "As a user submitting a support ticket, I need attachments to either work properly or not appear as an option, so I am not misled.",
      "acceptanceCriteria": [
        "Option A (implement): Add attachments.* validation rules (file|mimes:jpg,png,pdf,doc,docx|max:5120), store files using Laravel's filesystem, associate with ticket record",
        "Option B (remove): Remove the file input, drag-and-drop area, and enctype=\"multipart/form-data\" from the ticket form",
        "Whichever option is chosen, the UI and backend are consistent",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-006",
      "title": "Add Ticket Submission Success Feedback",
      "description": "As a user submitting a support ticket, I need visible confirmation that my ticket was submitted so I know it worked.",
      "acceptanceCriteria": [
        "ticket.blade.php includes an @if(session('success')) block rendering a styled success banner",
        "The success message is visible above the form after redirect",
        "The banner is accessible (has role=\"alert\" or aria-live=\"polite\")",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-007",
      "title": "Fix Cache Invalidation on View Count Increment",
      "description": "As a developer, I need view count increments to not wipe all category caches so that caching actually improves performance.",
      "acceptanceCriteria": [
        "TrackArticleView middleware uses DB::table('kb_articles')-\u003ewhere('id', ...)-\u003eincrement('view_count') (bypassing Eloquent model events) or guards cache invalidation against tracking-only column changes",
        "Category caches (kb_categories_with_counts, kb_all_categories_with_top_articles, kb_featured_articles) are NOT cleared on every page view",
        "Cache invalidation still triggers correctly when article content, title, or slug is actually edited",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-008",
      "title": "Fix N+1 Query in Category Sidebar",
      "description": "As a user browsing categories, I need pages to load fast without running a separate database query for every category in the sidebar.",
      "acceptanceCriteria": [
        "KnowledgeBaseController::category() eager-loads articles on $allCategories with -\u003ewith(['articles' =\u003e fn($q) =\u003e $q-\u003ewhere('is_published', true)-\u003elimit(5)]) or equivalent",
        "The category sidebar view (category.blade.php) uses the eager-loaded relationship instead of $cat-\u003earticles()-\u003e...-\u003eget()",
        "Redundant $category-\u003earticles()-\u003e...-\u003ecount() replaced with $articles-\u003etotal()",
        "$relatedCategories derived from $allCategories in PHP instead of a second DB query",
        "Total queries per category page reduced by N (where N = number of categories)",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false
    },
    {
      "id": "US-009",
      "title": "Eliminate Redundant Queries in TrackArticleView Middleware",
      "description": "As a developer, I need the view tracking middleware to not re-query the same article the controller already resolved.",
      "acceptanceCriteria": [
        "TrackArticleView middleware reuses the article resolved by the controller (e.g., via the request object or route model binding) instead of querying category + article again",
        "View tracking still only fires on successful 200 responses",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-010",
      "title": "Add Skip Navigation and Landmark Labels for Screen Readers",
      "description": "As a keyboard-only or screen reader user, I need a skip-to-content link and labeled landmarks so I can efficiently navigate the page (WCAG 2.4.1, 1.3.1).",
      "acceptanceCriteria": [
        "A visually hidden \"Skip to main content\" link is the first focusable element in layout.blade.php, visible on focus",
        "Each page's main content area has id=\"main-content\" on \u003cmain\u003e",
        "All \u003cnav\u003e elements have unique aria-label attributes (e.g., \"Main navigation\", \"Breadcrumb\", \"Table of contents\")",
        "All \u003caside\u003e elements have unique aria-label attributes",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-011",
      "title": "Add Labels to All Search Inputs",
      "description": "As a screen reader user, I need all search inputs to have accessible labels so I know what each field is for (WCAG 1.3.1, 3.3.2).",
      "acceptanceCriteria": [
        "Header search input has aria-label=\"Search knowledge base\" and a visually hidden \u003clabel\u003e",
        "Hero search inputs on landing, categories pages have aria-label and visually hidden \u003clabel\u003e",
        "All search inputs have an id for label association",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-012",
      "title": "Fix Material Icon Accessibility",
      "description": "As a screen reader user, I need decorative icons hidden and meaningful icons labeled so I hear useful content instead of icon ligature names like \"schedule\" or \"thumb_up\" (WCAG 1.1.1, 4.1.2).",
      "acceptanceCriteria": [
        "All decorative \u003cspan class=\"material-icons\"\u003e elements have aria-hidden=\"true\"",
        "Icons that convey meaning have adjacent \u003cspan class=\"sr-only\"\u003e text describing their purpose",
        "Screen reader does not announce ligature text like \"search\", \"schedule\", \"description\", \"thumb_up\"",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-013",
      "title": "Fix Breadcrumb Semantics",
      "description": "As a screen reader user, I need breadcrumbs to use proper \u003cnav\u003e with \u003col\u003e structure so I understand page hierarchy (WCAG 2.4.8).",
      "acceptanceCriteria": [
        "All breadcrumbs wrapped in \u003cnav aria-label=\"Breadcrumb\"\u003e",
        "Breadcrumb items use \u003col\u003e/\u003cli\u003e structure",
        "Current page item has aria-current=\"page\"",
        "Separator / spans have aria-hidden=\"true\"",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-014",
      "title": "Fix Heading Hierarchy",
      "description": "As a screen reader user, I need heading levels to not skip from \u003ch1\u003e to \u003ch5\u003e so I can navigate the page structure logically (WCAG 1.3.1).",
      "acceptanceCriteria": [
        "Sidebar headings in article and category views use \u003ch2\u003e or \u003ch3\u003e (not \u003ch5\u003e) with appropriate visual styling",
        "TOC heading (\"On this page\") uses appropriate heading level",
        "No heading level is skipped in any view",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-015",
      "title": "Fix Default Primary Color Contrast",
      "description": "As a user with low vision, I need the default primary color to meet WCAG AA contrast requirements so I can read link text and interactive elements (WCAG 1.4.3).",
      "acceptanceCriteria": [
        "Default primary color in config/kb.php changed from #0EA5E9 (2.68:1 ratio) to a darker variant like #0369A1 (4.63:1 ratio) or similar that meets 4.5:1 against white",
        "Focus ring opacity increased from primary/20 to at least primary/50 or replaced with a solid ring meeting 3:1 contrast",
        "Config documentation notes minimum recommended contrast ratio for custom colors",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-016",
      "title": "Fix Feedback Button Accessibility",
      "description": "As a screen reader user, I need feedback buttons to announce results and manage focus properly after voting (WCAG 4.1.2).",
      "acceptanceCriteria": [
        "Icon spans inside feedback buttons have aria-hidden=\"true\"",
        "Count spans have aria-live=\"polite\" for dynamic updates",
        "After vote submission, focus moves to the \"Thank you\" message",
        "\"Thank you\" container has role=\"status\" or aria-live=\"polite\"",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-017",
      "title": "Make Search Filters and Sort Functional",
      "description": "As a user searching for articles, I need category filters and sort options to actually work so I can narrow down results effectively.",
      "acceptanceCriteria": [
        "Category filter checkboxes are inside a \u003cform\u003e or wired via JavaScript to update search params",
        "SearchController accepts category parameter (by slug) and filters results",
        "Category filter is preserved across pagination (appends includes category)",
        "Sort dropdown submits a sort parameter (relevance, recent, oldest)",
        "SearchController applies sort ordering based on the parameter",
        "\"Clear all filters\" button resets filters and re-submits",
        "Category checkboxes wrapped in \u003cfieldset\u003e with \u003clegend\u003e for accessibility",
        "Empty query shows \"Browse all articles\" heading instead of Found N results for \"\"",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false
    },
    {
      "id": "US-018",
      "title": "Add Mobile Navigation Menu",
      "description": "As a mobile user, I need a navigation menu so I can access Home, Categories, and other pages without returning to the landing page.",
      "acceptanceCriteria": [
        "A hamburger menu button is visible below md breakpoint",
        "Tapping the hamburger opens a slide-out or dropdown menu with Home, Categories, and Support links",
        "Menu is keyboard-accessible with focus trap when open",
        "Menu button has aria-expanded and aria-controls attributes",
        "Menu closes on Escape key, outside click, and navigation",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false
    },
    {
      "id": "US-019",
      "title": "Standardize API Error Responses",
      "description": "As an API consumer, I need all error responses to follow a consistent structure so I can write a single error handler.",
      "acceptanceCriteria": [
        "All API error responses use structure: {\"error\": {\"message\": \"...\", \"code\": \"...\"}}",
        "401 from ApiAuthenticate uses the same error envelope",
        "404 (ModelNotFoundException) uses the same error envelope",
        "422 (validation errors) uses the same error envelope with a details field",
        "500 errors caught by a package-level exception handler return the same envelope",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false
    },
    {
      "id": "US-020",
      "title": "Add API Input Validation",
      "description": "As an API consumer, I need the API to validate input and return clear 422 errors so I can debug integration issues.",
      "acceptanceCriteria": [
        "API search endpoint validates q (max 500 chars) and category (exists as slug)",
        "API home endpoint has optional limit parameter for categories (default 20, max 100)",
        "Invalid input returns 422 with structured error response",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false
    },
    {
      "id": "US-021",
      "title": "Sanitize Config Values Used in CSS/JS Context",
      "description": "As a developer deploying the package, I need config values to be validated before injection into CSS and JavaScript contexts so that misconfigured values cannot break the page or enable injection.",
      "acceptanceCriteria": [
        "Service provider validates kb.colors.primary matches hex color pattern (/^#[0-9A-Fa-f]{6}$/)",
        "Service provider validates kb.font.family matches safe font name pattern (/^[a-zA-Z0-9 ]+$/)",
        "Invalid config values fall back to safe defaults with a logged warning",
        "JavaScript config injection uses @json() Blade directive instead of manual string interpolation",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false
    },
    {
      "id": "US-022",
      "title": "Replace Tailwind CDN with Compiled CSS",
      "description": "As a deployer, I need the package to not use Tailwind's CDN script in production so that pages load fast and don't depend on an external runtime.",
      "acceptanceCriteria": [
        "Tailwind CSS is compiled to a static CSS file during package build",
        "The \u003cscript src=\"cdn.tailwindcss.com\"\u003e tag and inline Tailwind config are removed from layout.blade.php",
        "The compiled CSS is loaded via a \u003clink\u003e tag (publishable asset)",
        "Font loading uses \u003clink rel=\"preconnect\"\u003e hints for Google Fonts domains",
        "Page renders correctly without JavaScript enabled (CSS-only)",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "US-023",
      "title": "Fix Ticket Form Toolbar and Dead Buttons",
      "description": "As a user, I need non-functional UI elements either implemented or removed so I am not confused by buttons that do nothing.",
      "acceptanceCriteria": [
        "Ticket form text formatting toolbar buttons (bold, italic, list, link) either function with JavaScript or are removed",
        "\"Start Live Chat\" button on landing page either links to a configurable chat URL or is removed",
        "\"Start Live Chat Instead\" link on ticket page either links to a configurable URL or is removed",
        "\"Support\" breadcrumb link on ticket page points to a valid URL (not href=\"#\")",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "US-024",
      "title": "Fix Stale Cache on Article Slug Change",
      "description": "As a content editor, I need old article URLs to not serve stale cached content after I change an article's slug.",
      "acceptanceCriteria": [
        "On article update, the model observer checks for slug changes and invalidates the old cache key kb_article_{old_slug}",
        "Article saving event captures original slug via $article-\u003egetOriginal('slug')",
        "Both old and new slug cache keys are cleared on save",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "US-025",
      "title": "Cache Search Page Categories and Ticket Featured Articles",
      "description": "As a developer, I need consistent caching across all controllers so that identical data is not re-queried on different pages.",
      "acceptanceCriteria": [
        "SearchController reuses the kb_categories_with_counts cache key for its category list",
        "TicketController caches featured articles or reuses kb_featured_articles cache key",
        "KnowledgeBaseController::article() adds a reasonable -\u003elimit() to sidebar article query",
        "Eager-loaded articles in kb_categories_with_counts limited to what is actually displayed (not all articles)",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "US-026",
      "title": "Add Database Index Recommendations",
      "description": "As a developer, I need the package migration to include appropriate indexes so that queries perform well at scale.",
      "acceptanceCriteria": [
        "Migration (or documentation) recommends indexes on: kb_categories(slug), kb_categories(is_active, sort_order), kb_articles(slug), kb_articles(is_published, is_featured), kb_articles(category_id), kb_articles(view_count)",
        "Indexes are added via a publishable migration or documented in README",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "US-027",
      "title": "Add Prev/Next Article Navigation",
      "description": "As a user reading an article, I need prev/next links so I can read through articles in a category sequentially.",
      "acceptanceCriteria": [
        "KnowledgeBaseController::article() queries for previous and next articles within the same category (ordered by title or sort order)",
        "article.blade.php renders prev/next links in the existing empty \u003cnav\u003e placeholder",
        "Links show the article title and a directional arrow",
        "If no prev/next exists, that side is empty (no broken link)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false
    },
    {
      "id": "US-028",
      "title": "Add read_time Field Consistency",
      "description": "As a developer, I need a single consistent field name for article read time so views and API don't silently return null.",
      "acceptanceCriteria": [
        "A single field name is used everywhere: either read_time or read_time_minutes",
        "article.blade.php, category.blade.php, and ApiController.php all reference the same field",
        "If the field doesn't exist on the model, a computed accessor is added",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false
    },
    {
      "id": "US-029",
      "title": "Extract Shared Markdown Helpers",
      "description": "As a developer maintaining the package, I need addHeadingIds() and extractHeadings() in one place so bug fixes don't need to be applied twice.",
      "acceptanceCriteria": [
        "addHeadingIds() and extractHeadings() extracted to a shared service or trait",
        "Both KnowledgeBaseController and ApiController use the shared implementation",
        "No duplicated markdown parsing logic",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false
    },
    {
      "id": "US-030",
      "title": "Add Ticket Form Label Association and Toolbar Accessibility",
      "description": "As a screen reader user, I need the ticket form's attachment label properly associated with its input, and toolbar buttons to have accessible names (WCAG 1.3.1, 4.1.2).",
      "acceptanceCriteria": [
        "Outer \"Attachments (Optional)\" label has for=\"file-upload\" attribute",
        "Toolbar buttons have aria-label attributes (e.g., aria-label=\"Bold\")",
        "Toolbar icon spans have aria-hidden=\"true\"",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false
    },
    {
      "id": "US-031",
      "title": "Add Mobile TOC Toggle",
      "description": "As a mobile user reading a long article, I need access to the table of contents so I can jump to specific sections.",
      "acceptanceCriteria": [
        "A collapsible \"On this page\" toggle button is visible on mobile (below lg breakpoint)",
        "Tapping the toggle reveals the TOC as an overlay or accordion",
        "TOC active state updates on scroll (using IntersectionObserver)",
        "Active TOC item has aria-current=\"true\"",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false
    }
  ]
}